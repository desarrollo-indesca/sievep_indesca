{% extends 'base.html' %}
{% load static %}
{% load l10n %}
{% load widget_tweaks %}

{% block head %}
<script src="/static/js/htmx.min.js"></script>
<meta name="htmx-config" content='{"useTemplateFragments":"true"}'>
<link rel="stylesheet" href="{% static 'css/htmx-indicator.css' %}">

<style>
    input, select {
        min-height: auto !important;
        font-size: 0.6rem !important;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@bokeh/bokehjs@3.7.0/build/js/bokeh.min.js"></script>
{% endblock %}

{% block contenido %}
<div class="row mb-3">
    <div class="col-md-3 col-lg-2 d-inline-flex justify-content-center align-items-center"><a class="btn d-block btn-secondary" href="{% url 'consulta_compresores' %}">↶ Regresar</a></div>
    <div class="col-md-6 col-lg-8"><h3 class="text-center" style="color: #e31e24;">Nueva Evaluación Compresor {{compresor.tag}}</h3></div>
    <div class="col-md-3 col-lg-2"><button type="button" class="btn btn-success" style="color: black;" data-bs-toggle="modal" data-bs-target="#ficha_{{compresor.pk}}"><img width="25px" src="{% static 'img/iconos/ficha.png' %}" alt="Mostrar ficha técnica">&nbsp;Ficha Técnica</button></div>
</div>

<hr>

<form hx-confirm="¿Desea realizar esta acción?" id="form" method="post" name="form" hx-target="#resultados" hx-post="{% url 'evaluacion_compresor' pk=compresor.pk %}#resultados" hx-trigger="submit" hx-indicator="#spinner">
    {% csrf_token %}
    <div class="row">
        <div class="col-12">
            <label for="evaluacion-nombre" class="form-label">Nombre de la Evaluación</label>
            <input type="text" id="evaluacion-nombre" name="evaluacion-nombre" class="form-control" required>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-7">
            <h5 class="text-center">Datos de Entrada</h5>
            <hr>

            <table class="table table-sm text-center" style="font-size: xx-small;">
                <thead>
                    <tr class="table-dark">
                        <th>Parámetro</th>
                        {% for etapa in compresor.casos.first.etapas.all %}
                        <th>Etapa {{etapa.numero}}</th>
                        {% endfor %}
                    </tr>
                </thead>

                <tbody>
                    <tr class="table-dark text-white">
                        <th colspan="{{compresor.casos.first.etapas.count|add:1}}">Datos de Flujo, Potencia, Cabezal de Ficha</th>
                    </tr>
                    <tr>
                        <td>Flujo de Gas</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.flujo_gas class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-flujo_gas_unidad" id="id_{{form.prefix}}-flujo_gas_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='F' pk_selected=form.initial.flujo_gas_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Flujo Volumétrico</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.flujo_volumetrico class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-flujo_volumetrico_unidad" id="id_{{form.prefix}}-flujo_volumetrico_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='K' pk_selected=form.initial.flujo_volumetrico_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Flujo Surge</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.flujo_surge class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-flujo_volumetrico_unidad" id="id_{{form.prefix}}-flujo_volumetrico_unidad" class="form-select form-select-sm" disabled>
                                    {% include 'unidades.html' with tipo='K' pk_selected=form.initial.flujo_volumetrico_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Velocidad</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.velocidad class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-velocidad_unidad" id="id_{{form.prefix}}-velocidad_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='O' pk_selected=form.initial.velocidad_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="table-dark text-white">
                        <th colspan="{{compresor.casos.first.etapas.count|add:1}}">
                            Para Cabezal Hidráulico
                        </th>
                    </tr>
                    <tr>
                        <td>Cabezal Politrópico</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.cabezal_politropico class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-cabezal_politropico_unidad" id="id_{{form.prefix}}-cabezal_politropico_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='L' pk_selected=form.initial.cabezal_politropico_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="table-dark text-white">
                        <th colspan="{{compresor.casos.first.etapas.count|add:1}}">
                            Cálculo de la Potencia
                        </th>
                    </tr>
                    <tr>
                        <td>Potencia Generada</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.potencia_generada class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-potencia_generada_unidad" id="id_{{form.prefix}}-potencia_generada_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='B' pk_selected=form.initial.potencia_generada_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="table-dark text-white">
                        <th colspan="{{compresor.casos.first.etapas.count|add:1}}">
                            Cálculo de Eficiencia
                        </th>
                    </tr>
                    <tr>
                        <td>Eficiencia Politrópica (%)</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.eficiencia_politropica class="form-control form-control-sm" %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="table-dark text-white">
                        <th colspan="{{compresor.casos.first.etapas.count|add:1}}">
                            Condiciones de la Corriente
                        </th>
                    </tr>
                    <tr>
                        <td>Presión Entrada</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.presion_in class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-presion_unidad" id="id_{{form.prefix}}-presion_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='P' pk_selected=form.initial.presion_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Presión Salida</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.presion_out class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-presion_unidad" id="id_{{form.prefix}}-presion_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='P' pk_selected=form.initial.presion_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Temperatura Entrada</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.temperatura_in class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-temperatura_unidad" id="id_{{form.prefix}}-temperatura_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='T' pk_selected=form.initial.temperatura_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Temperatura Salida</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.temperatura_out class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-temperatura_unidad" id="id_{{form.prefix}}-temperatura_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='T' pk_selected=form.initial.temperatura_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th class="table-dark text-white" colspan="{{compresor.casos.first.etapas.count|add:1}}">
                            Cáculos de Coeficientes Isentrópicos
                        </th>
                    </tr>
                    <tr>
                        <td>K Entrada</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.k_in class="form-control form-control-sm" %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>K Salida</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.k_out class="form-control form-control-sm" %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th class="table-dark text-white" colspan="{{compresor.casos.first.etapas.count|add:1}}">
                            Cálculo de Factor de Compresibilidad
                        </th>
                    </tr>
                    <tr>
                        <td>Z Entrada</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.z_in class="form-control form-control-sm" %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Z Salida</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.z_out class="form-control form-control-sm" %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th class="table-dark text-white" colspan="{{compresor.casos.first.etapas.count|add:1}}">
                            PM Ficha
                        </th>
                    </tr>
                    <tr>
                        <td>PM Ficha</td>
                        {% for etapa,form in forms.entradas_etapa.items %}
                        <td>
                            <div class="input-group">
                                {% render_field form.pm_ficha class="form-control form-control-sm" %}
                                <select name="{{form.prefix}}-pm_ficha_unidad" id="id_{{form.prefix}}-pm_ficha_unidad" class="form-select form-select-sm">
                                    {% include 'unidades.html' with tipo='W' pk_selected=form.initial.pm_ficha_unidad.pk %}
                                </select>
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="col-5">
            <h5 class="text-center">Composición del Combustible por Etapa</h5>
            <hr>

            <table class="table table-sm table-bordered table-sm text-center" style="font-size: xx-small;">
                <thead>
                    <tr class="table-dark">
                        <th>Compuesto</th>
                        {% for etapa in compresor.casos.first.etapas.all %}
                        <th>Etapa {{etapa.numero}}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for fluido,forms_etapas in forms.composiciones.items %}
                    <tr>
                        <td class="table-dark">{{fluido}}</td>
                        {% for form_etapa in forms_etapas %}
                        <td>
                            <div class="input-group">
                                {% render_field form_etapa.porc_molar class="form-control form-control-sm" %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="resultados">

    </div>

    <div class="d-flex justify-content-center">
        <button type="submit" id="submit" name="submit" value="calcular" class="btn btn-danger">Calcular Resultados</button>
    </div>
</form>

<div id="spinner" class="htmx-indicator indicator-style">
    <div class="spinner-grow text-danger" style="width: 6rem; height: 6rem;">
    </div>
</div>

{% include 'compresores/partials/ficha.html' %}
{% endblock %}

{% block extra_javascript %}
<script src="/static/js/turbinas/vapor/evaluacion.js"></script>
<script>
    document.addEventListener('input', (e)=>{
        if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT'){
            document.getElementById('submit').outerHTML = ' <button type="submit" id="submit" name="submit" value="calcular" class="btn btn-danger">Calcular Resultados</button>';
            document.getElementById('resultados').innerHTML = '';
        }
    });

    const selects_flujo_volumetrico_unidad = document.querySelectorAll('select[name*="-flujo_volumetrico_unidad"]');
    selects_flujo_volumetrico_unidad.forEach((select1)=>{
        selects_flujo_volumetrico_unidad.forEach((select2)=>{
            if(select1.name === select2.name && select1 !== select2){
                select1.addEventListener('change', (e)=>{
                    select2.value = e.target.value;
                });
            }
        });
    });
</script>
{% endblock %}