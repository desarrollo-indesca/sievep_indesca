{% extends 'base.html' %}
{% load static %}

{% block contenido %}
    <form method="post">
        {% with generales=intercambiador.intercambiador %}
        <div class="row">
            <div class="col-md-3 col-lg-2 d-flex justify-content-center align-items-center h-100"><a class="btn d-block btn-secondary" href="{% url 'consulta_evaluaciones_tubo_carcasa' pk=intercambiador.pk %}">↶ Regresar</a></div>
            <div class="col-md-6 col-lg-8"><h3 class="text-center" style="color: #e31e24;">Nueva Evaluación para el Intercambiador {{generales.tag}}</h3></div>
            <div class="col-md-3 col-lg-2 d-flex justify-content-center align-items-center h-100">
                {% include 'fichas/intercambiadores/tubo_carcasa.html' %}
                <button type="button" class="btn btn-danger text-dark" data-bs-toggle="modal" data-bs-target="#ficha_{{intercambiador.pk}}"><img width="25px" src="{% static 'img/iconos/ficha.png' %}" alt="Mostrar ficha técnica"> Ficha Técnica</button>
            </div>
        </div>
        {% endwith %}
    
        <hr>
    
        <div class="row">
            <div class="col-3 d-flex flex-column">
                <label class="form-label" for="metodo">Nombre de la Evaluación:</label>
                <input type="text" class="form-control" name="nombre">
            </div>

            <div class="col-3 d-flex flex-column">
                <label class="form-label" for="metodo">Método:</label>
                <select required class="form-select" name="metodo" id="metodo">
                    <option value="NTU">Eficiencia-NTU</option>
                    <option value="LMTD">LMTD</option>
                    <option value="DOS">Ambos</option>
                </select>
            </div>
    
            <div class="col-3 d-flex flex-column">
                <label class="form-label" for="condiciones">Condiciones:</label>
                <select required class="form-select" name="condiciones" id="condiciones">
                    <option value="D">De Diseño</option>
                </select>
            </div>

            <div class="col-3 d-flex flex-column">
                <label class="form-label" for="no_tubos">Número de Tubos:</label>
                <input type="number" min="1" class="form-control" id="no_tubos" name="no_tubos" value="{{intercambiador.numero_tubos}}">
            </div>
        </div>
    
        <hr>
    
        <div class="row">
            <div class="col-6 border-end ">
                <h4 class="text-center mb-3">Carcasa</h4>
    
                <div class="row">
                    <div class="col-6 d-flex flex-column">
                        <label class="form-label" for="temp_in_carcasa">Temperatura Entrada:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control temperatura campo" type="number" name="temp_in_carcasa" id="temp_in_carcasa" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select campo" name="unidad_temperaturas" id="unidad_temperaturas">
                                <option value="1">°C</option>
                                <option value="2">K</option>
                                <option value="3">°F</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="temp_out_carcasa">Temperatura Salida:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control temperatura campo" type="number" name="temp_out_carcasa" id="temp_out_carcasa" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select" name="unidad_temperaturas" id="unidad_temperaturas" disabled>
                                <option value="1">°C</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6 d-flex flex-column">
                        <label class="form-label" for="fluido_carcasa">Fluido:</label>
                        <select disabled class="form-select" name="fluido_carcasa" id="fluido_carcasa" disabled>
                            <option value="1">{{intercambiador.fluido_carcasa}}</option>
                        </select>
                    </div>
                    <div class="col-6 d-flex flex-column">
                        <label class="form-label" for="cp_carcasa">Cp:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" type="number" name="cp_carcasa" id="cp_carcasa" class="form-control campo">
                            <select style="width: 30% !important;" class="form-select campo" name="unidad_cp" id="unidad_cp">
                                <option value="1">J/molK</option>
                                <option value="2">J/gK</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="flujo_carcasa">Flujo Másico (Kg/h):</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control campo" type="number" name="flujo_carcasa" id="flujo_carcasa" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select campo" name="unidad_flujo" id="unidad_flujo">
                                <option value="1">Kg/h</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="caida_carcasa">Caída de Presión:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control campo" type="number" name="caida_carcasa" id="caida_carcasa" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select campo" name="unidad_presion" id="unidad_presion">
                                <option value="1">bar</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <h4 class="text-center mb-3">Tubo</h4>
                <div class="row">
                    <div class="col-6 d-flex flex-column">
                        <label class="form-label" for="temp_in_tubo">Temperatura Entrada:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control temperatura campo" type="number" name="temp_in_tubo" id="temp_in_tubo" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select" name="unidad_temperaturas" id="unidad_temperaturas" disabled>
                                <option value="1">°C</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="temp_out_tubo">Temperatura Salida:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control temperatura campo" type="number" name="temp_out_tubo" id="temp_out_tubo" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select" name="unidad_temperaturas" id="unidad_temperaturas" disabled>
                                <option value="1">°C</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6 d-flex flex-column">
                        <label class="form-label" for="fluido_tubo">Fluido:</label>
                        <select disabled class="form-select" name="fluido_tubo" id="fluido_tubo" disabled>
                            <option value="1">{{intercambiador.fluido_tubo}}</option>
                        </select>
                    </div>
                    <div class="col-6 d-flex flex-column">
                        <label class="form-label" for="cp_tubo">Cp:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" type="number" name="cp_tubo" id="cp_tubo" class="form-control campo">
                            <select style="width: 30% !important;" class="form-select" name="unidad_cp" id="unidad_cp" disabled>
                                <option value="1">J/molK</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="flujo_tubo">Flujo Másico (Kg/h):</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control campo" type="number" name="flujo_tubo" id="flujo_tubo" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select" name="unidad_temperaturas" id="unidad_flujo" disabled>
                                <option value="1">Kg/h</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="caida_tubo">Caída de Presión:</label>
                        <div class="input-group mb-3">
                            <input style="width: 70% !important;" class="form-control campo" type="number" name="caida_tubo" id="caida_tubo" step="0.01" min="-273.15" max="9999.99" required>
                            <select style="width: 30% !important;" class="form-select" name="unidad_temperaturas" id="unidad_temperaturas" disabled>
                                <option value="1">bar</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <hr>
        <div class="row p-1">
            <div class="col-6 row border-end g-2">
                <div class="col-12">
                    <h5 class="text-center">Cálculo de Resultados</h5>
                </div>

                <div class="col-4 d-flex flex-column">
                    <label class="form-label">LMTD:</label>
                    <input id="lmtd" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">Área Transf. (m²):</label>
                    <input id="area" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">NTU:</label>
                    <input id="ntu" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">Efectividad:</label>
                    <input id="efectividad" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">U (Kcal/hCm²)</label>
                    <input id="u" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">UA (Kcal/hC):</label>
                    <input id="UA" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">% Eficiencia:</label>
                    <input id="eficiencia" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">Ensuciamiento:</label>
                    <input id="ensuciamiento" disabled type="text" class="form-control">
                </div>
                <div class="col-4 d-flex flex-column">
                    <label class="form-label">Q:</label>
                    <input id="q" disabled type="text" class="form-control">
                </div>
            </div>
            <div class="col-6">
                <canvas id="grafica_1" style="width: 100%;"></canvas> <!-- Gráfica -->
            </div>     
        </div>
        <hr>
        
        <div class="d-flex justify-content-center mb-3">
            <button class="btn btn-danger" disabled>Registrar Resultados De La Evaluación</button>
        </div>
    </form>
{% endblock %}

{% block extra_javascript %}
<script>
    let chart = null;
    let canvas = document.getElementById('grafica_1').getContext('2d');
    let datosGrafica = undefined;

    $('input.temperatura').change((e) => {
        canvas = document.getElementById('grafica_1').getContext('2d');
        
        if(chart)
            chart.destroy();

        let data = [{data: {}},{data: {}}];

        if($('#temp_in_carcasa').val() !== ""){
            data[0].data.Inicial = Number($('#temp_in_carcasa').val());
        }

        if($('#temp_out_carcasa').val() !== ""){
            data[0].data.Final = Number($('#temp_out_carcasa').val());
        }

        if($('#temp_in_tubo').val() !== ""){
            data[1].data.Inicial = Number($('#temp_in_tubo').val());
        }

        if($('#temp_out_tubo').val() !== ""){
            data[1].data.Final = Number($('#temp_out_tubo').val());
        }

        data[0].label = "Tubo Externo";
        data[0].backgroundColor = ['#E31E24'];
        data[0].borderColor = ['#E31E24'];

        data[1].label = "Tubo Interno";
        data[1].backgroundColor = ['#555'];
        data[1].borderColor = ['#555'];

        console.log(data);

        chart = new Chart(canvas, {
            type: 'line',
            data: {
                datasets: data
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Variación de las Temperaturas',
                        position: 'top'
                    },
                    legend: {
                        display: true
                    }
                }        
            }
        });
    
        console.log(chart.data);
    });

    chart = new Chart(canvas, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: "Tubo Externo",
                        data: {},
                        backgroundColor: ['#E31E24'],
                        borderColor: ['#E31E24']
                    },
                    {
                        label: "Tubo Interno",
                        data: {},
                        backgroundColor: ['#555'],
                        borderColor: ['#555']
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Variación de las Temperaturas',
                        position: 'top'
                    },
                    legend: {
                        display: true
                    }
                }        
            }
        });
</script>

<script>
    function ajaxCP(t1,t2,fluido, lado = 'T'){
        $.ajax({
            url: '/intercambiadores/calcular_cp/',
            data: {
                t1,
                t2,
                fluido
            },
            success: (res) => {
                console.log(res.cp);
                if(res.cp !== '')
                    if(lado === 'T')
                        $('#cp_tubo').val(res.cp);
                    else
                        $('#cp_carcasa').val(res.cp);     
            }, 
            error: (res) => {
                console.log(res);
            }
        });
    }

    $('#temp_out_carcasa').change((e) => {
        if($('#temp_out_carcasa').val() !== '' && $('#temp_in_carcasa').val() !== ''){
            ajaxCP($('#temp_in_carcasa').val(), $('#temp_out_carcasa').val(), $('#fluido_carcasa').val(), 'C');
        }
    });

    $('#temp_in_carcasa').change((e) => {
        if($('#temp_out_carcasa').val() !== '' && $('#temp_in_carcasa').val() !== '')
            ajaxCP($('#temp_in_carcasa').val(), $('#temp_out_carcasa').val(), $('#fluido_carcasa').val(), 'C');
    });

    $('#temp_out_tubo').change((e) => {
        if($('#temp_out_tubo').val() !== '' && $('#temp_in_tubo').val() !== ''){
            ajaxCP($('#temp_in_tubo').val(), $('#temp_out_tubo').val(), $('#fluido_tubo').val(), 'T');
        }
    });

    $('#fluido_tubo').change((e) => {
        if($('#temp_out_tubo').val() !== '' && $('#temp_in_tubo').val() !== '')
            ajaxCP($('#temp_in_tubo').val(), $('#temp_out_tubo').val(), $('#fluido_tubo').val(), 'T');
    });

    $('.campo').change((e) => {
        const array = $('.campo').toArray();

        if(array.every((x) => x.value !== '')){
            $.ajax({
                url: '/intercambiadores/evaluar/tubo_carcasa/{{intercambiador.pk}}/',
                data: {
                    temp_in_carcasa: document.getElementById('temp_in_carcasa').value,
                    temp_out_carcasa: document.getElementById('temp_out_carcasa').value,
                    temp_in_tubo: document.getElementById('temp_in_tubo').value,
                    temp_out_tubo: document.getElementById('temp_out_tubo').value,
                    flujo_tubo: document.getElementById('flujo_tubo').value,
                    flujo_carcasa: document.getElementById('flujo_carcasa').value,
                    no_tubos: document.getElementById('no_tubos').value
                },
                success: (res) => {        
                    console.log(res);   
                    document.getElementById('lmtd').value = res.lmtd;
                    document.getElementById('area').value = res.area;
                    document.getElementById('ntu').value = res.ntu;
                    document.getElementById('u').value = res.u;
                    document.getElementById('ua').value = res.ua;
                    document.getElementById('eficiencia').value = res.eficiencia;
                    document.getElementById('ensuciamiento').value = res.factor_ensuciamento;
                    document.getElementById('q').value = res.q;
                }, 
                error: (res) => {
                    console.log(res);
                }
            });
        }
    });

</script>
{% endblock %}